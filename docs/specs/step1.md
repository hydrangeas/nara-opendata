# ステップ1：ドメインイベントと外部システムの抽出

## タイムライン表現方法

### 方法2: Flowchart図（並行処理を表現する場合）

```mermaid
graph LR
    %% Social Login認証フロー
    subgraph "Social Login認証フロー"
        A1[ログイン/サインアップボタンがクリックされた🟧]
        A2[Supabase Authへリダイレクトされた🟧]
        A4[Social Provider認証ページにリダイレクトされた🟧]
        A6[認証成功コールバックが受信された🟧]
        A7[認証失敗コールバックが受信された🟧]
        A16[トップページにリダイレクトされた🟧]
        A14[ダッシュボードが表示された🟧]
        
        A1 --> A2
        A2 --> A4
        A4 --> A6
        A4 --> A7
        A7 --> A16
        A6 --> A14
    end
    
    %% APIアクセスフロー（正常系）
    subgraph "APIアクセスフロー - 正常系"
        C1[APIリクエストが受信された🟧]
        C2[JWTトークンが検証された🟧]
        C3[ユーザーティアが確認された🟧]
        C4[レート制限がチェックされた🟧]
        C5[レート制限カウントが更新された🟧]
        C6[JSONファイルが読み込まれた🟧]
        C7[レスポンスが返却された🟧]
        
        C1 --> C2
        C2 --> C3
        C3 --> C4
        C4a --> C5
        C5 --> C6
        C6 --> C7
    end
    
    %% APIアクセスフロー（エラー系）
    subgraph "APIアクセスフロー - エラー系"
        D1[無効なトークンが検出された🟧]
        D2[認証エラーが返却された🟧]
        D3[レート制限を超過した🟧]
        D4[レート制限エラーが返却された🟧]
        D5[ファイルが見つからなかった🟧]
        D6[404エラーが返却された🟧]
        
        C2 -.-> D1
        D1 --> D2
        C4b -.-> D4
        C6 -.-> D5
        D5 --> D6
    end
    
    %% ログアウトフロー
    subgraph "ログアウトフロー"
        E1[ログアウトボタンがクリックされた🟧]
        E2[セッションが無効化された🟧]
        E3[トップページにリダイレクトされた🟧]
        
        E1 --> E2
        E2 --> E3
    end
    
    %% トークンリフレッシュフロー
    subgraph "トークンリフレッシュフロー"
        F1[アクセストークンの有効期限が切れた🟧]
        F2[リフレッシュトークンが送信された🟧]
        F3[Supabase Authにリフレッシュ要求が送信された🟫]
        F4[新しいアクセストークンが発行された🟧]
        
        F1 --> F2
        F2 --> F3
        F3 --> F4
    end
    
    %% ログ記録フロー（並行処理）
    subgraph "ログ記録フロー - 並行処理"
        G1[認証成功がログに記録された🟧]
        G2[認証失敗がログに記録された🟧]
        G3[レート制限違反がログに記録された🟧]
        G4[APIアクセスがログに記録された🟧]
        
        A6 -.-> G1
        A7 -.-> G2
        E2 -.-> G1
        C4b -.-> G3
        C7 -.-> G4
    end
    
    %% スタイル定義
    classDef event fill:#ff6723,stroke:#333,stroke-width:2px;
    classDef command fill:#00a6ed,stroke:#333,stroke-width:2px;
    classDef user fill:#ffffff,stroke:#333,stroke-width:2px;
    classDef externalSystem fill:#a56953,stroke:#333,stroke-width:2px;
    classDef aggregate fill:#ffb02e,stroke:#333,stroke-width:2px;
    classDef policy fill:#00d26a,stroke:#333,stroke-width:2px;
    classDef readModel fill:#000000,color:#fff,stroke:#333,stroke-width:2px;
    
    class A1,A2,A4,A6,A7,A14,A16,C1,C2,C3,C4,C5,C6,C7,D1,D2,D3,D4,D5,D6,E1,E2,E3,F1,F2,F4,G1,G2,G3,G4 event;
    class F3 externalSystem;
```

## タイムラインの説明

### 表現方法の選択ガイド

このプロジェクトでは**方法2: Flowchart図**を選択しました。理由：
- 複数の並行処理が存在（ログ記録、エラー処理など）
- 条件分岐による異なるフローが多数存在
- 各フロー間の関連性を明確に表現する必要がある

## タイムラインの説明

- ログイン/サインアップボタンがクリックされた（ドメインイベント🟧）
  トップページでユーザーが認証プロセスを開始したイベント
  
- Supabase Authへリダイレクトされた（ドメインイベント🟧）
  Supabase Authの認証ページへの遷移が実行されたイベント
  
- Social Provider認証ページにリダイレクトされた（ドメインイベント🟧）
  外部認証プロバイダーのログイン画面への遷移が実行されたイベント
  
- 認証成功コールバックが受信された（ドメインイベント🟧）
  Supabase Authから認証成功の結果がコールバックで返され、JWTトークン（tier情報を含む）とユーザー情報が含まれるイベント
  
- 認証失敗コールバックが受信された（ドメインイベント🟧）
  ユーザーが認証をキャンセルした、または認証プロバイダーでエラーが発生した結果がコールバックで返されたイベント
  
- トップページにリダイレクトされた（ドメインイベント🟧）
  認証失敗後にトップページへの遷移が実行されたイベント
  
- ダッシュボードが表示された（ドメインイベント🟧）
  認証後のユーザー画面が表示されたイベント
  
- APIリクエストが受信された（ドメインイベント🟧）
  クライアントからAPIエンドポイントへのリクエストが到着したイベント
  
- JWTトークンが検証された（ドメインイベント🟧）
  Authorizationヘッダーのトークンが有効性を確認されたイベント
  
- ユーザーティアが確認された（ドメインイベント🟧）
  トークンからユーザーのティア情報（tier1/tier2/tier3）が取得されたイベント
  
- レート制限がチェックされた（ドメインイベント🟧）
  現在の時間枠でのAPIアクセス回数が確認されたイベント
  
- レート制限カウントが更新された（ドメインイベント🟧）
  Supabaseデータベースでアクセス回数が増加されたイベント
  
- JSONファイルが読み込まれた（ドメインイベント🟧）
  要求されたオープンデータのJSONファイルがファイルシステムから取得されたイベント
  
- レスポンスが返却された（ドメインイベント🟧）
  クライアントにJSONデータが正常に送信されたイベント
  
- 認証エラーが返却された（ドメインイベント🟧）
  HTTP 401 Unauthorizedエラーがクライアントに返されたイベント（JWTトークン検証失敗時）
  
- レート制限内であることが確認された（ドメインイベント🟧）
  ユーザーのAPIアクセス回数が設定制限内であることが確認されたイベント
  
- レート制限を超過した（ドメインイベント🟧）
  ユーザーのAPIアクセス回数が設定された制限を超えたイベント
  
- レート制限エラーが返却された（ドメインイベント🟧）
  HTTP 429 Too Many Requestsエラーと次回アクセス可能時刻が返されたイベント
  
- ファイルが見つからなかった（ドメインイベント🟧）
  要求されたJSONファイルがファイルシステムに存在しなかったイベント
  
- 404エラーが返却された（ドメインイベント🟧）
  RFC 7807形式のHTTP 404エラーレスポンスが返されたイベント
  
- ログアウトボタンがクリックされた（ドメインイベント🟧）
  ユーザーがダッシュボードからログアウトを実行したイベント
  
- セッションが無効化された（ドメインイベント🟧）
  ユーザーのセッション情報がクリアされたイベント
  
- トップページにリダイレクトされた（ドメインイベント🟧）
  ログアウト後にトップページへの遷移が実行されたイベント
  
- アクセストークンの有効期限が切れた（ドメインイベント🟧）
  1時間の有効期限を過ぎたアクセストークンが検出されたイベント
  
- リフレッシュトークンが送信された（ドメインイベント🟧）
  新しいアクセストークン取得のためリフレッシュトークンが使用されたイベント
  
- Supabase Authにリフレッシュ要求が送信された（外部システム🟫）
  外部認証システムへのトークンリフレッシュリクエスト
  
- 新しいアクセストークンが発行された（ドメインイベント🟧）
  リフレッシュ成功により新たなアクセストークンが生成されたイベント（tier情報を含む）
  
- 認証成功がログに記録された（ドメインイベント🟧）
  監査用に認証成功情報がログファイルに出力されたイベント
  
- 認証失敗がログに記録された（ドメインイベント🟧）
  セキュリティ監視用に認証失敗情報がログに記録されたイベント
  
- レート制限違反がログに記録された（ドメインイベント🟧）
  不正アクセス検知用にレート制限超過がログに記録されたイベント
  
- APIアクセスがログに記録された（ドメインイベント🟧）
  アクセス履歴としてAPI呼び出し情報がログに保存されたイベント

## 保留事項 (Future Placement Board)

|タイプ|内容|検討ステップ|
|-|-|-|
|コマンド🟦|ユーザーがログイン/サインアップを要求する|ステップ2|
|コマンド🟦|クライアントがAPIを呼び出す|ステップ2|
|懸念事項🟪|Supabase Auth UIコンポーネントがプロバイダー選択から外部認証ページへのリダイレクトまで自動処理|ステップ2|
|懸念事項🟪|ティアのアップグレード/ダウングレードのフローが未定義|ステップ2|
|懸念事項🟪|リフレッシュトークンの有効期限切れ時の処理|ステップ2|
|懸念事項🟪|APIドキュメント（Scalar）の表示フロー|ステップ2|
|懸念事項🟪|CORS設定の具体的な実装方法|ステップ3|
|懸念事項🟪|セキュリティヘッダーの設定タイミング|ステップ3|

## ユビキタス言語辞書

|項番|日本語|英語|コード変数|意味|使用コンテキスト|最終更新|
|-|-|-|-|-|-|-|
|1|ユーザー|User|user|システムを利用する人|全体|2025-01-06|
|2|認証|Authentication|auth|ユーザーの身元を確認するプロセス|認証|2025-01-06|
|3|認可|Authorization|authz|ユーザーのアクセス権限を確認するプロセス|アクセス制御|2025-01-06|
|4|ティア|Tier|tier|ユーザーのアクセスレベル（tier1/tier2/tier3）|アクセス制御|2025-01-06|
|5|レート制限|Rate Limit|rateLimit|1分間あたりのAPIアクセス回数制限|アクセス制御|2025-01-06|
|6|アクセストークン|Access Token|accessToken|API認証用の短期有効トークン（1時間）|認証|2025-01-06|
|7|リフレッシュトークン|Refresh Token|refreshToken|アクセストークン更新用の長期有効トークン（30日）|認証|2025-01-06|
|8|オープンデータ|Open Data|openData|奈良県が公開している公共データ|データ提供|2025-01-06|
|9|ダッシュボード|Dashboard|dashboard|認証後のユーザー画面|UI|2025-01-06|
|10|セッション|Session|session|ユーザーのログイン状態を管理する仕組み|認証|2025-01-06|
|11|エラーレスポンス|Error Response|errorResponse|RFC 7807形式のエラー情報|エラー処理|2025-01-06|
|12|監査ログ|Audit Log|auditLog|セキュリティ監視用の記録|セキュリティ|2025-01-06|
|13|Social Provider|Social Provider|socialProvider|外部認証プロバイダー（Google、GitHub等）|認証|2025-01-06|
|14|認証コールバック|Auth Callback|authCallback|外部認証プロバイダーからの認証結果通知|認証|2025-01-06|
|15|初回ログイン|First Login|firstLogin|システムへの初めてのログイン|認証|2025-01-06|

## チェックリスト

完了基準(21項目)の確認結果

### ドメインイベントの質と量

- [x] すべてのドメインイベントが過去形の動詞で表現されている
- [x] ドメインイベントがオレンジ色の付箋に1つずつ記載されている
- [x] 十分な量のドメインイベントが出されている（質より量を重視）
- [x] 重複や類似するイベントが許容されている（この段階での整理は不要）
- [x] すべての主要なビジネスプロセスがイベントとして表現されている
- [x] ドメインイベントがビジネス上の「重要な出来事」を表している

### 外部システムの識別

- [x] システムに関連する外部システムやサービスが識別されている
- [x] 外部システム起因のイベントが茶色で記録されている
- [x] 外部システムとの連携点・インターフェースが明示されている

### ユビキタス言語品質基準

- [x] 技術用語とビジネス用語の整合性
- [x] コード変数名の命名規則準拠
- [x] コンテキスト依存性の明示
- [x] 過去形動詞との矛盾なし

### シナリオ整合性

- [x] 各フロー間のイベント競合なし
- [x] 共有リソースの状態の整合性

### 見直し

- [x] ビジネスドメイン上で発生するすべての重要なイベントを挙げられたか？
- [x] 見落としている重要なビジネスプロセスはないか？
- [x] 現在のイベント群は、ドメインの全体像を十分に表しているか？

- [x] イベントの表現は全て過去形になっているか？
- [x] イベントの粒度は適切か？（細かすぎたり、大きすぎたりしていないか？）
- [x] 類似するイベントが多数ある領域は、さらに詳細化が必要ではないか？

- [x] すべての外部システムとの連携点を特定できたか？
- [x] 外部システム起因のイベントは明確に区別されているか？
- [x] 外部システムとの連携において、見落としている重要なイベントはないか？

- [x] 疑問点や懸念事項は全て紫色付箋に記録されているか？
- [x] ホットスポット（優先的に議論が必要なエリア）が識別されているか？
- [x] ピボットイベント（ビジネスの転換点）が明確に識別されているか？
- [x] 次のステップ（イベントとシステム間のギャップを埋める）に進む準備ができているか？
- [x] 現状の時系列の流れに矛盾や不自然な点はないか？

### 進化的アプローチの確認

- [x] このステップの内容は十分に熟考されているか？
- [x] 後のステップで大幅な修正が必要になりそうな箇所はないか？
- [x] 不確実な部分は保留事項として明確に記録されているか？

- [x] 変更履歴を記載したか？

## 補足

本プロジェクトでは、並行処理が多く発生するため、Flowchart図（LR方向）を採用しました。特に、ログ記録フローは他のフローと並行して実行される非同期処理として表現しています。

Social Loginの採用により、ユーザー登録とログインのフローが統合されました。初回ログイン時にユーザーアカウントの作成とtier1の割り当てが自動的に行われ、既存ユーザーは直接認証プロセスに進みます。

Supabase Auth UIコンポーネントを使用することで、プロバイダー選択画面、サインイン/サインアップフォーム、パスワードリセット等の認証に必要なUI要素がすべて提供されます。これにより、認証フローの実装が大幅に簡素化されます。

Supabase AuthはCustom Access Token Hookを使用して、JWT発行時に自動的にユーザーのティア情報をトークンに含めます。この処理はSupabase Auth内部で実行されるPostgreSQL関数として実装され、アプリケーションからは観測できません。初回ユーザーの場合はtier1が、既存ユーザーの場合は保存済みのtier情報がJWTクレームに含まれます。アプリケーション側では、発行されたJWTにtier情報が含まれていることを前提として処理を行います。

また、エラー処理フローは正常系フローからの分岐として表現し、各エラーケースが独立したイベントとして扱われることを明確にしています。

## 変更履歴

|更新日時|変更点|
|-|-|
|2025-01-12T18:00:00+09:00|レート制限フローを修正。C4をC4a（制限内）とC4b（制限超過）に分岐。D1「無効なトークンが検出された」とD3「レート制限を超過した」を削除。ログ記録フローを修正（E2からG1へのログアウトログ追加）|
|2025-01-11T18:00:00+09:00|認証コールバックを成功/失敗で分割（A6, A7）。A8「ユーザー情報が取得された」、A15「認証がキャンセル/失敗した」を削除|
|2025-01-11T17:30:00+09:00|A5「Social Providerが認証を処理した」を削除、A9「ユーザー作成とJWT発行が開始された」を削除。外部システムからの複数イベント生成を修正|
|2025-01-11T17:00:00+09:00|Custom Access Token Hook関連のイベント（A10, A11, F3a）を削除。アプリケーションから観測できない内部処理のため|
|2025-01-11T16:00:00+09:00|Supabase Authによるユーザー自動作成とtier設定を反映。初回ログイン判定とユーザー作成の責務をSupabase Authに委譲|
|2025-01-11T15:00:00+09:00|Custom Access Token Hookの採用を反映（JWT発行時のティア情報自動含有、補足事項に説明追加）|
|2025-01-11T13:00:00+09:00|「Supabase Authがユーザー情報を処理した」イベントを削除し、認証コールバックから直接分岐するよう修正|
|2025-01-11T12:30:00+09:00|認証失敗・キャンセルのパターンを追加（A15, A16イベント）|
|2025-01-11T12:00:00+09:00|Supabase Auth UIコンポーネントの内部処理（Social Provider選択イベント）を削除|
|2025-01-11T11:00:00+09:00|ログインページを廃止し、トップページから直接Supabase Authへリダイレクトする方式に変更|
|2025-01-06T14:00:00+09:00|Social Loginを採用し、ユーザー登録・ログインフローを統合|
|2025-01-06T11:00:00+09:00|Supabase認証への完全委任を反映し、認証関連の詳細イベントを削除|
|2025-01-06T10:00:00+09:00|新規作成|