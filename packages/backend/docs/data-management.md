# データ管理ガイドライン

## 目次

1. [概要](#概要)
2. [ディレクトリ構造](#ディレクトリ構造)
3. [ファイル命名規則](#ファイル命名規則)
4. [JSONフォーマット](#jsonフォーマット)
5. [データ更新手順](#データ更新手順)
6. [セキュリティガイドライン](#セキュリティガイドライン)
7. [トラブルシューティング](#トラブルシューティング)

## 概要

このドキュメントは、奈良県オープンデータAPI のデータファイル管理に関するガイドラインです。
すべてのデータファイルはJSON形式で管理され、APIを通じてのみアクセス可能です。

## ディレクトリ構造

```
data/
├── secure/          # 認証が必要なデータ
│   ├── population/  # 人口統計データ
│   ├── budget/      # 予算データ
│   └── statistics/  # 各種統計データ
├── public/          # 公開データ（将来の拡張用）
├── index.json       # データカタログ
├── .htaccess        # アクセス制御（Apache環境用）
└── .gitignore       # Git管理設定
```

### ディレクトリの説明

#### `/data/secure/`
- **用途**: 認証が必要なデータを配置
- **アクセス**: APIを通じてのみアクセス可能
- **セキュリティ**: JWTトークン認証必須

#### `/data/public/`
- **用途**: 将来的に認証不要なデータを配置予定
- **現状**: 現在は使用していません
- **将来**: サンプルデータや一般公開情報を配置予定

## ファイル命名規則

### 基本ルール

1. **小文字のみ使用**
   - ✅ 良い例: `population-2024.json`
   - ❌ 悪い例: `Population-2024.JSON`

2. **スペースはハイフンで置換**
   - ✅ 良い例: `age-distribution.json`
   - ❌ 悪い例: `age distribution.json`

3. **日本語ファイル名は禁止**
   - ✅ 良い例: `education.json`
   - ❌ 悪い例: `教育統計.json`

4. **拡張子は `.json` のみ**
   - ✅ 良い例: `data.json`
   - ❌ 悪い例: `data.JSON`, `data.txt`

5. **年度データは4桁の西暦を使用**
   - ✅ 良い例: `2024.json`
   - ❌ 悪い例: `r6.json`, `24.json`

### カテゴリ別命名規則

#### 人口統計（population）
- 年次データ: `{year}.json` (例: `2024.json`)
- メタデータ: `metadata.json`

#### 予算（budget）
- 年度別: `{year}/general.json`
- 詳細: `{year}/details.json`

#### 統計（statistics）
- 分野別: `{field}.json` (例: `education.json`, `health.json`)

## JSONフォーマット

### 必須構造

すべてのデータファイルは以下の構造を持つ必要があります：

```json
{
  "metadata": {
    "source": "データ提供元",
    "lastUpdated": "YYYY-MM-DD",
    "license": "ライセンス情報"
  },
  // ... データ本体
}
```

### メタデータフィールド

| フィールド | 必須 | 説明 | 例 |
|-----------|------|------|-----|
| source | ✅ | データの提供元組織 | "奈良県統計課" |
| lastUpdated | ✅ | 最終更新日 | "2024-12-01" |
| license | ✅ | ライセンス情報 | "CC BY 4.0" |
| dataCollectionMethod | ⭕ | データ収集方法 | "住民基本台帳" |
| notes | ⭕ | 補足情報 | "令和6年度調査" |

### 日付フォーマット

| 種類 | フォーマット | 例 |
|------|-------------|-----|
| 日付 | YYYY-MM-DD | 2024-12-01 |
| 日時 | ISO 8601 | 2024-12-01T09:00:00Z |
| 年度 | YYYY | 2024 |

### 数値の扱い

- 整数: カンマなし（例: `1234567`）
- 小数: 必要な桁数のみ（例: `123.45`）
- パーセント: 小数で表現（例: `0.128` = 12.8%）
- 金額: 円単位、カンマなし（例: `1000000`）

## データ更新手順

### 1. データファイルの準備

```bash
# データファイルをUTF-8で保存
# エディタでJSON形式を確認
```

### 2. JSON検証

```bash
# 検証スクリプトの実行
npm run validate:json

# または直接実行
node scripts/validate-json.js
```

### 3. ファイルの配置

```bash
# 適切なディレクトリにコピー
cp new-data.json data/secure/category/

# 権限の確認（Unix系OSの場合）
ls -la data/secure/category/new-data.json
```

### 4. インデックスの更新

`data/index.json` を更新して新しいファイルを追加：

```json
{
  "categories": {
    "category": {
      "files": ["existing.json", "new-data.json"]
    }
  }
}
```

### 5. 動作確認

```bash
# 開発サーバーで確認
npm run dev

# APIエンドポイントをテスト
curl -H "Authorization: Bearer TOKEN" \
  http://localhost:3000/api/v1/data/secure/category/new-data.json
```

## セキュリティガイドライン

### 1. アクセス制御

- **直接アクセスの防止**
  - `.htaccess` によるディレクトリ保護
  - Web サーバー設定での制限
  - APIを通じてのみアクセス可能

### 2. パストラバーサル対策

- **禁止文字**
  - `..` (親ディレクトリ参照)
  - 絶対パス（`/etc/passwd` など）
  - 特殊文字（`<>|*?` など）

### 3. ファイルサイズ制限

- **推奨上限**: 10MB
- **大容量データの扱い**:
  - ページネーション実装
  - データの分割
  - ストリーミング対応

### 4. データの検証

- **入力検証**
  - JSON構文チェック
  - スキーマ検証
  - エンコーディング確認

### 5. 機密情報の除外

- **含めてはいけない情報**:
  - 個人情報（氏名、住所、電話番号）
  - APIキーやパスワード
  - 内部システムの詳細情報

## トラブルシューティング

### JSONパースエラー

**症状**: `Unexpected token` エラー

**原因と対策**:
1. **構文エラー**
   - JSONLint (https://jsonlint.com/) で検証
   - カンマ、括弧、引用符を確認

2. **エンコーディング**
   - UTF-8で保存されているか確認
   - BOM（Byte Order Mark）を除去

3. **改行コード**
   - LF（Unix形式）に統一

### ファイルが見つからない

**症状**: 404 Not Found エラー

**確認事項**:
1. **パスの確認**
   - 大文字・小文字の違い
   - ディレクトリ構造

2. **ファイル権限**
   ```bash
   # 読み取り権限があるか確認
   ls -la data/secure/category/file.json
   ```

3. **インデックス登録**
   - `data/index.json` に記載されているか

### アクセス権限エラー

**症状**: 403 Forbidden エラー

**対策**:
1. **認証トークン**
   - 有効なJWTトークンか確認
   - トークンの有効期限

2. **ユーザー権限**
   - 適切なティア（tier）か確認
   - アクセス制限設定

### パフォーマンス問題

**症状**: レスポンスが遅い

**最適化方法**:
1. **ファイルサイズ**
   - 10MB以下に分割
   - 不要なデータを削除

2. **キャッシュ活用**
   - ETagヘッダーの利用
   - 条件付きリクエスト

3. **データ構造**
   - 深いネストを避ける
   - 配列の要素数を制限

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2025-01-15 | 1.0.0 | 初版作成 |

---

質問や問題がある場合は、プロジェクトのIssueトラッカーでお問い合わせください。